<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        /* 简单的样式提示 */
        #pwd-match-msg {
            display: block;
            margin-top: 4px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <text>账户</text>
    <input id="account">
    <button id="sendcode">发送验证码</button>
    <input id="code" placeholder="请输入验证码">
    <button id="verifycode">验证验证码</button>
    <input id="password" placeholder="请输入新密码" type="password">
    <input id="rePassword" placeholder="请再次输入密码" type="password">
    <button id="reset">更改密码</button>
</body>
</html>
<script src="/webjars/jquery/3.7.1/jquery.js"></script>
<script src="config.js"></script>
<script>
    var codeErrorTimes=0;
    $(window).on("load",function () {
        //个人中心进入时，下行启用开始
        var account=localStorage.getItem("account");
        $("#account").val(account);
        $("#account").prop("disabled",true);
        //启用结束
        $("#code").prop("disabled",true);
        $("#verifycode").prop("disabled",true);
        $("#password").prop("disabled",true);
        $("#rePassword").prop("disabled",true);
        $("#reset").prop("disabled",true);
    })

    $("#sendcode").click(function () {
        //console.log(1);
        $.ajax({
            url:config.baseUrl+"/reset/mail/code?account="+$("#account").val(),
            method:"put",
            dataType:"json",
            success:function (res) {
                console.log(res);
                if(res.status==="success"){
                    alert("验证码已发送！");
                    $("#sendcode").prop("disabled",true);
                    $("#code").prop("disabled",false);
                    $("#verifycode").prop("disabled",false);
                }else {
                    alert("账户不存在");
                }
            },
            error:function (err) {
                alert("邮箱格式错误");
            }
        })
    })

    $("#verifycode").click(function () {
        var Code=$("#code").val();
        if(!Code){
            alert("验证码不能为空!");
            return;
        }
        $.ajax({
            url:config.baseUrl+"/reset/mail/verify?code="+Code+"&account="+$("#account").val(),
            method: "get",
            success:function (res) {
                console.log(res);
                if(res.isMatch==="true"){
                    alert("验证成功");
                    $("#password").prop("disabled",false);
                    $("#rePassword").prop("disabled",false);
                    $("#reset").prop("disabled",false);
                    $("#verifycode").prop("disabled",true);
                }else {
                    if(res.status==="invalid"){
                        alert("验证码错误，请重新输入");
                        codeErrorTimes++;
                        if(codeErrorTimes===3){
                            alert("已错误三次，请重新获取验证码");
                            $("#sendcode").prop("disabled",false);
                            $("#code").prop("disabled",true);
                            $("#verifycode").prop("disabled",true);
                        }
                    }else {
                        alert("验证码过期，请重新获取验证码");
                        $("#sendcode").prop("disabled",false);
                        $("#code").prop("disabled",true);
                        $("#verifycode").prop("disabled",true);
                    }
                }
            }
        })
    })

    $("#reset").click(function () {
        $("#reset").prop("disabled",true);
        //已经校验过
        $.ajax({
            url:config.baseUrl+"/reset/password",
            method:"put",
            contentType: "application/json; charset=UTF-8",
            dataType: "json",
            data:JSON.stringify({
                "account":$("#account").val(),
                "password":$("#password").val()
            }),
            success:function (res) {
                if(res.status==="success"){
                    alert("修改密码成功！");
                    localStorage.removeItem("JWT");
                    localStorage.removeItem("account");
                    sessionStorage.removeItem("password");
                    //主页返回即可
                    //window.history.back();
                    window.location.replace("/index.html");
                }
            },
            error:function (err) {
                alert("网络连接错误");
                $("#reset").prop("disabled",false);
            }
        })
    })

    function checkPasswords() {
        var pwd = $("#password").val();
        var rpt = $("#rePassword").val();
        var $msg = $("#pwd-match-msg");
        var $btn = $("#reset");

        // 如果任意一项为空，则清空提示并禁用按钮
        if (!pwd || !rpt) {
            $msg.text("");
            $btn.prop("disabled", true);
            return;
        }

        // // 长度校验
        // if (pwd.length < 6) {
        //     $msg.text("密码至少 6 位").css("color", "orange");
        //     $btn.prop("disabled", true);
        //     return;
        // }

        // 匹配校验
        if (pwd === rpt) {
            $msg.text("✓ 两次输入一致").css("color", "green");
            $btn.prop("disabled", false);
        } else {
            $msg.text("✗ 两次输入不一致").css("color", "red");
            $btn.prop("disabled", true);
        }
    }

    // 监听 input 事件，实时触发校验
    $("#password, #rePassword").on("input", checkPasswords);
</script>